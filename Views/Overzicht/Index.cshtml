@using Pastashop.Models
@using System.Linq
@model IEnumerable<Bestelling>

@{
    ViewData["Title"] = "Overzicht bestellingen";
}

<h2>@ViewData["Title"]</h2>

<table class="table table-striped table-hover align-middle">
    <thead>
    <tr>
        <th>Line</th>
        <th>OrderNummer</th>
        <th>Product</th>
        <th>Aantal</th>
        <th>Klant</th>
        <th>Datum</th>
        <th>Status</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var o in Model)
    {
        // sort lines per order (by Id; tweak if you like another order)
        var lijnen = (o.Regels ?? new List<BestellingsRegel>())
            .OrderBy(r => r.Id)
            .ToList();

        if (lijnen.Count == 0)
        {
            // Fallback for old orders without lines: show a single row
            <tr class="@(o.Afgeleverd ? "is-delivered" : "")">
                <td>1</td>
                <td>@o.OrderNummer</td>
                <td>@o.Product</td>
                <td>@o.Aantal</td>
                <td>@o.Klant</td>
                <td>@o.Datum.ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                    @if (!o.Afgeleverd)
                    {
                        <form asp-action="MarkAfgeleverd" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@o.Id" />
                            <button class="btn btn-sm btn-success">Afgeleverd</button>
                        </form>
                    }
                    else
                    {
                        <form asp-action="UndoAfgeleverd" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@o.Id" />
                            <span class="badge bg-success-subtle text-success border border-success-subtle me-2">Afgeleverd</span>
                            <button class="btn btn-sm btn-outline-secondary">Ongedaan</button>
                        </form>
                    }
                </td>
            </tr>
        }
        else
        {
            for (int i = 0; i < lijnen.Count; i++)
            {
                var r = lijnen[i];
                <tr class="@(o.Afgeleverd ? "is-delivered" : "")">
                    <td>@(i + 1)</td>
                    <td>@(i == 0 ? o.OrderNummer : "")</td>
                    <td>@r.Pasta @r.Grootte met @r.Saus</td>
                    <td>@r.Aantal</td>
                    <td>@(i == 0 ? o.Klant : "")</td>
                    <td>@(i == 0 ? o.Datum.ToString("yyyy-MM-dd HH:mm") : "")</td>
                    <td>
                        @if (i == 0)
                        {
                            if (!o.Afgeleverd)
                            {
                                <form asp-action="MarkAfgeleverd" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@o.Id" />
                                    <button class="btn btn-sm btn-success">Afgeleverd</button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="UndoMarkAfgeleverd" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@o.Id" />
                                    <span class="badge bg-success-subtle text-success border border-success-subtle me-2">Afgeleverd</span>
                                    <button class="btn btn-sm btn-outline-secondary">Ongedaan</button>
                                </form>
                            }
                        }
                        else
                        {
                            @:
                        }
                    </td>
                </tr>
            }
        }
    }
    </tbody>
</table>

<style>
/* Smooth green highlight for delivered orders (applies to ALL rows in that order) */
tr.is-delivered {
  background-color: #eaf9ea !important;   /* soft green */
  transition: background-color .35s ease;
}
/* Subtle success badge background (Bootstrap-like) */
.badge.bg-success-subtle {
  background-color: #dff5df;
}
</style>
